# CLAUDE.md - FLEXT Web

This file provides guidance to Claude Code when working with the flext-web project.

## Project Overview

FLEXT Web provides a modern Django-based web application for the FLEXT data integration platform. It implements Clean Architecture with Django, offering a comprehensive web interface for pipeline management, monitoring, and REDACTED_LDAP_BIND_PASSWORDistration.

## Project Type

**Django Web Application** - Modern web interface with Django 5.1+ and Clean Architecture patterns.

## Development Commands

All commands should be run from the project directory (`/home/marlonsc/flext/flext-web/`):

```bash
# Quality checks (run these before committing)
make check                  # Run all quality checks (lint + type + test)
make test                   # Run Django tests with coverage
make lint                   # Run ruff linting
make type-check             # Run mypy type checking
make format                 # Format code with ruff

# Development
make install                # Install dependencies
make build                  # Build static assets
make clean                  # Clean build artifacts
make dev-install            # Install in development mode

# Django operations
make migrate                # Run database migrations
make makemigrations         # Create new migrations
make collectstatic          # Collect static files
make createsuperuser        # Create Django superuser
make runserver              # Start development server
make shell                  # Django shell
```

## Architecture

### Clean Architecture + Django

```
src/flext_web/
├── domain/                 # Domain layer - business logic
│   ├── entities/          # Pipeline, User, Project entities
│   ├── value_objects/     # Configuration, Status values
│   ├── aggregates/        # Pipeline aggregate root
│   └── interfaces/        # Repository interfaces
├── application/           # Application layer - use cases
│   ├── commands/          # Command handlers
│   ├── queries/           # Query handlers
│   ├── services/          # Application services
│   └── dto/               # Data transfer objects
├── infrastructure/        # Infrastructure layer
│   ├── persistence/       # Django ORM repositories
│   ├── external/          # External API clients
│   ├── messaging/         # Event publishing
│   └── cache/             # Redis caching
├── interfaces/            # Interface adapters
│   ├── web/              # Django views and forms
│   ├── api/              # Django REST Framework
│   ├── templates/        # HTML templates
│   └── static/           # CSS, JS, images
└── config/               # Django configuration
    ├── settings/         # Environment-specific settings
    ├── urls.py          # URL routing
    └── wsgi.py          # WSGI application
```

### Django Apps Structure

```
flext_web/
├── apps/
│   ├── pipelines/        # Pipeline management
│   ├── monitoring/       # System monitoring
│   ├── users/           # User management
│   ├── projects/        # Project organization
│   ├── plugins/         # Plugin management
│   └── api/             # REST API endpoints
├── static/              # Static assets
├── templates/           # HTML templates
├── locale/              # Internationalization
└── media/               # User uploads
```

## Technology Stack

- **Python 3.13**: Latest Python with modern typing
- **Django 5.1+**: Modern Django with async views
- **Django REST Framework**: API development
- **PostgreSQL**: Primary database
- **Redis**: Caching and sessions
- **Celery**: Background task processing
- **WhiteNoise**: Static file serving
- **Poetry**: Dependency management

## Django Models

### Pipeline Models

```python
from django.db import models
from django.contrib.auth.models import User
from flext_core.domain.entities import Pipeline as PipelineDomain

class Pipeline(models.Model):
    """Pipeline Django model."""
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4)
    name = models.CharField(max_length=100, unique=True)
    description = models.TextField(blank=True)
    extractor = models.CharField(max_length=100)
    loader = models.CharField(max_length=100)
    transform = models.CharField(max_length=100, blank=True)
    config = models.JSONField(default=dict)
    is_active = models.BooleanField(default=True)
    created_by = models.ForeignKey(User, on_delete=models.CASCADE)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'pipelines'
        ordering = ['-created_at']
    
    def to_domain(self) -> PipelineDomain:
        """Convert Django model to domain entity."""
        return PipelineDomain(
            id=self.id,
            name=self.name,
            description=self.description,
            extractor=self.extractor,
            loader=self.loader,
            transform=self.transform,
            config=self.config,
            is_active=self.is_active,
            created_by=str(self.created_by.id),
            created_at=self.created_at,
            updated_at=self.updated_at
        )

class Execution(models.Model):
    """Pipeline execution model."""
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4)
    pipeline = models.ForeignKey(Pipeline, on_delete=models.CASCADE)
    status = models.CharField(max_length=20, choices=[
        ('pending', 'Pending'),
        ('running', 'Running'),
        ('success', 'Success'),
        ('failed', 'Failed'),
        ('cancelled', 'Cancelled'),
    ])
    started_at = models.DateTimeField()
    finished_at = models.DateTimeField(null=True, blank=True)
    duration_seconds = models.IntegerField(null=True, blank=True)
    records_processed = models.IntegerField(null=True, blank=True)
    error_message = models.TextField(blank=True)
    triggered_by = models.ForeignKey(User, on_delete=models.CASCADE)
    
    class Meta:
        db_table = 'executions'
        ordering = ['-started_at']
```

## Django Views

### Class-Based Views

```python
from django.views.generic import ListView, DetailView, CreateView
from django.contrib.auth.mixins import LoginRequiredMixin
from flext_web.apps.pipelines.models import Pipeline
from flext_web.apps.pipelines.forms import PipelineForm

class PipelineListView(LoginRequiredMixin, ListView):
    """List view for pipelines."""
    
    model = Pipeline
    template_name = 'pipelines/list.html'
    context_object_name = 'pipelines'
    paginate_by = 20
    
    def get_queryset(self):
        """Filter pipelines by user permissions."""
        queryset = super().get_queryset()
        if not self.request.user.is_superuser:
            queryset = queryset.filter(created_by=self.request.user)
        return queryset

class PipelineDetailView(LoginRequiredMixin, DetailView):
    """Detail view for pipeline."""
    
    model = Pipeline
    template_name = 'pipelines/detail.html'
    context_object_name = 'pipeline'
    
    def get_context_data(self, **kwargs):
        """Add executions to context."""
        context = super().get_context_data(**kwargs)
        context['recent_executions'] = self.object.execution_set.all()[:10]
        return context

class PipelineCreateView(LoginRequiredMixin, CreateView):
    """Create view for pipeline."""
    
    model = Pipeline
    form_class = PipelineForm
    template_name = 'pipelines/create.html'
    
    def form_valid(self, form):
        """Set created_by to current user."""
        form.instance.created_by = self.request.user
        return super().form_valid(form)
```

### Async Views (Django 5.1+)

```python
from django.views import View
from django.http import JsonResponse
import asyncio

class AsyncPipelineExecutionView(LoginRequiredMixin, View):
    """Async view for pipeline execution."""
    
    async def post(self, request, pipeline_id):
        """Execute pipeline asynchronously."""
        try:
            pipeline = await Pipeline.objects.aget(id=pipeline_id)
            
            # Use async service to execute pipeline
            execution_service = PipelineExecutionService()
            execution = await execution_service.execute_async(
                pipeline_id=pipeline_id,
                user_id=request.user.id
            )
            
            return JsonResponse({
                'execution_id': str(execution.id),
                'status': execution.status,
                'started_at': execution.started_at.isoformat()
            })
            
        except Pipeline.DoesNotExist:
            return JsonResponse({'error': 'Pipeline not found'}, status=404)
        except Exception as e:
            logger.exception("Pipeline execution failed")
            return JsonResponse({'error': str(e)}, status=500)
```

## Django Forms

### Model Forms

```python
from django import forms
from flext_web.apps.pipelines.models import Pipeline

class PipelineForm(forms.ModelForm):
    """Form for pipeline creation and editing."""
    
    class Meta:
        model = Pipeline
        fields = ['name', 'description', 'extractor', 'loader', 'transform', 'config']
        widgets = {
            'description': forms.Textarea(attrs={'rows': 3}),
            'config': forms.Textarea(attrs={'rows': 10, 'class': 'json-editor'}),
        }
    
    def __init__(self, *args, **kwargs):
        """Initialize form with dynamic choices."""
        super().__init__(*args, **kwargs)
        
        # Load available extractors and loaders
        self.fields['extractor'].widget = forms.Select(choices=self.get_extractor_choices())
        self.fields['loader'].widget = forms.Select(choices=self.get_loader_choices())
    
    def get_extractor_choices(self):
        """Get available extractor plugins."""
        # Query available extractors from plugin registry
        return [
            ('tap-postgres', 'PostgreSQL'),
            ('tap-mysql', 'MySQL'),
            ('tap-oracle', 'Oracle'),
        ]
    
    def clean_config(self):
        """Validate JSON configuration."""
        config = self.cleaned_data['config']
        if config:
            try:
                import json
                if isinstance(config, str):
                    json.loads(config)
            except json.JSONDecodeError:
                raise forms.ValidationError("Invalid JSON configuration")
        return config
```

## REST API (Django REST Framework)

### Serializers

```python
from rest_framework import serializers
from flext_web.apps.pipelines.models import Pipeline, Execution

class PipelineSerializer(serializers.ModelSerializer):
    """Serializer for Pipeline model."""
    
    created_by = serializers.StringRelatedField(read_only=True)
    
    class Meta:
        model = Pipeline
        fields = '__all__'
        read_only_fields = ['id', 'created_by', 'created_at', 'updated_at']
    
    def validate_config(self, value):
        """Validate pipeline configuration."""
        if not isinstance(value, dict):
            raise serializers.ValidationError("Config must be a valid JSON object")
        return value

class ExecutionSerializer(serializers.ModelSerializer):
    """Serializer for Execution model."""
    
    pipeline_name = serializers.CharField(source='pipeline.name', read_only=True)
    triggered_by_name = serializers.CharField(source='triggered_by.username', read_only=True)
    
    class Meta:
        model = Execution
        fields = '__all__'
        read_only_fields = ['id', 'duration_seconds']
```

### API ViewSets

```python
from rest_framework import viewsets, status
from rest_framework.decorators import action
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated

class PipelineViewSet(viewsets.ModelViewSet):
    """ViewSet for Pipeline operations."""
    
    serializer_class = PipelineSerializer
    permission_classes = [IsAuthenticated]
    
    def get_queryset(self):
        """Filter pipelines by user permissions."""
        if self.request.user.is_superuser:
            return Pipeline.objects.all()
        return Pipeline.objects.filter(created_by=self.request.user)
    
    def perform_create(self, serializer):
        """Set created_by to current user."""
        serializer.save(created_by=self.request.user)
    
    @action(detail=True, methods=['post'])
    def execute(self, request, pk=None):
        """Execute pipeline endpoint."""
        pipeline = self.get_object()
        
        try:
            # Use application service to execute pipeline
            execution_service = PipelineExecutionService()
            execution = execution_service.execute_pipeline(
                pipeline_id=pipeline.id,
                user_id=request.user.id,
                full_refresh=request.data.get('full_refresh', False)
            )
            
            serializer = ExecutionSerializer(execution)
            return Response(serializer.data, status=status.HTTP_201_CREATED)
            
        except Exception as e:
            return Response(
                {'error': str(e)}, 
                status=status.HTTP_400_BAD_REQUEST
            )
```

## Configuration

### Settings Structure

```python
# settings/base.py
from flext_core.config import BaseSettings

class DjangoSettings(BaseSettings):
    """Django configuration settings."""
    
    # Django settings
    SECRET_KEY: str
    DEBUG: bool = False
    ALLOWED_HOSTS: list[str] = []
    
    # Database
    DATABASE_URL: str = "postgresql://localhost/flext_web"
    
    # Redis
    REDIS_URL: str = "redis://localhost:6379/0"
    
    # Celery
    CELERY_BROKER_URL: str = "redis://localhost:6379/0"
    CELERY_RESULT_BACKEND: str = "redis://localhost:6379/0"

# settings/development.py
from .base import *

DEBUG = True
ALLOWED_HOSTS = ['localhost', '127.0.0.1']

# settings/production.py
from .base import *

DEBUG = False
ALLOWED_HOSTS = ['your-domain.com']
```

### Environment Variables

```bash
# Django Configuration
DJANGO_SETTINGS_MODULE=flext_web.config.settings.production
DJANGO_SECRET_KEY=your-secret-key
DJANGO_DEBUG=false
DJANGO_ALLOWED_HOSTS=your-domain.com

# Database
DATABASE_URL=postgresql://user:pass@localhost/flext_web

# Redis
REDIS_URL=redis://localhost:6379/0

# Celery
CELERY_BROKER_URL=redis://localhost:6379/0
CELERY_RESULT_BACKEND=redis://localhost:6379/0
```

## Dependencies

### Core Dependencies

```toml
# FLEXT Core
flext-core = { path = "../flext-core", develop = true }
flext-auth = { path = "../flext-auth", develop = true }
flext-api = { path = "../flext-api", develop = true }

# Django Framework
django = ">=5.1.0,<5.2.0"
djangorestframework = ">=3.14.0,<4.0.0"
django-extensions = ">=3.2.0,<4.0.0"
django-debug-toolbar = ">=4.2.0,<5.0.0"

# Database & Caching
psycopg = ">=3.1.0,<4.0.0"
redis = ">=5.0.0,<6.0.0"
django-redis = ">=5.4.0,<6.0.0"

# Background Tasks
celery = ">=5.3.0,<6.0.0"
django-celery-results = ">=2.5.0,<3.0.0"

# Static Files & Media
whitenoise = ">=6.6.0,<7.0.0"
pillow = ">=10.0.0,<11.0.0"
```

## Testing Standards

### Django Testing

```python
from django.test import TestCase, TransactionTestCase
from django.contrib.auth.models import User
from flext_web.apps.pipelines.models import Pipeline

class PipelineModelTest(TestCase):
    """Test Pipeline model."""
    
    def setUp(self):
        """Set up test data."""
        self.user = User.objects.create_user(
            username='testuser',
            email='test@example.com',
            password='testpass123'
        )
    
    def test_create_pipeline(self):
        """Test pipeline creation."""
        pipeline = Pipeline.objects.create(
            name='test-pipeline',
            extractor='tap-postgres',
            loader='target-snowflake',
            created_by=self.user
        )
        
        self.assertEqual(pipeline.name, 'test-pipeline')
        self.assertEqual(pipeline.created_by, self.user)
        self.assertTrue(pipeline.is_active)
    
    def test_pipeline_to_domain(self):
        """Test conversion to domain entity."""
        pipeline = Pipeline.objects.create(
            name='test-pipeline',
            extractor='tap-postgres',
            loader='target-snowflake',
            created_by=self.user
        )
        
        domain_pipeline = pipeline.to_domain()
        self.assertEqual(domain_pipeline.name, pipeline.name)
        self.assertEqual(domain_pipeline.extractor, pipeline.extractor)

class PipelineViewTest(TestCase):
    """Test Pipeline views."""
    
    def setUp(self):
        """Set up test data."""
        self.user = User.objects.create_user(
            username='testuser',
            password='testpass123'
        )
        self.client.login(username='testuser', password='testpass123')
    
    def test_pipeline_list_view(self):
        """Test pipeline list view."""
        response = self.client.get('/pipelines/')
        self.assertEqual(response.status_code, 200)
        self.assertContains(response, 'Pipelines')
```

### API Testing

```python
from rest_framework.test import APITestCase
from rest_framework import status
from django.contrib.auth.models import User

class PipelineAPITest(APITestCase):
    """Test Pipeline API endpoints."""
    
    def setUp(self):
        """Set up test data."""
        self.user = User.objects.create_user(
            username='testuser',
            password='testpass123'
        )
        self.client.force_authenticate(user=self.user)
    
    def test_create_pipeline_api(self):
        """Test pipeline creation via API."""
        data = {
            'name': 'test-pipeline',
            'extractor': 'tap-postgres',
            'loader': 'target-snowflake',
            'config': {'host': 'localhost'}
        }
        
        response = self.client.post('/api/v1/pipelines/', data)
        self.assertEqual(response.status_code, status.HTTP_201_CREATED)
        self.assertEqual(response.data['name'], 'test-pipeline')
```

## Frontend Integration

### Static Assets

```html
<!-- templates/base.html -->
{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>FLEXT Web</title>
    <link rel="stylesheet" href="{% static 'css/main.css' %}">
    <script src="{% static 'js/main.js' %}"></script>
</head>
<body>
    {% block content %}{% endblock %}
</body>
</html>
```

### JavaScript Integration

```javascript
// static/js/pipeline.js
class PipelineManager {
    constructor() {
        this.apiBase = '/api/v1/pipelines/';
    }
    
    async executePipeline(pipelineId) {
        try {
            const response = await fetch(`${this.apiBase}${pipelineId}/execute/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCsrfToken()
                }
            });
            
            const data = await response.json();
            this.updateExecutionStatus(data);
            
        } catch (error) {
            console.error('Pipeline execution failed:', error);
        }
    }
    
    getCsrfToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }
}
```

## Background Tasks (Celery)

### Task Definition

```python
from celery import shared_task
from flext_web.apps.pipelines.models import Pipeline, Execution

@shared_task(bind=True)
def execute_pipeline_task(self, pipeline_id, user_id):
    """Execute pipeline in background."""
    try:
        pipeline = Pipeline.objects.get(id=pipeline_id)
        
        # Create execution record
        execution = Execution.objects.create(
            pipeline=pipeline,
            status='running',
            triggered_by_id=user_id,
            started_at=timezone.now()
        )
        
        # Execute pipeline using application service
        execution_service = PipelineExecutionService()
        result = execution_service.execute_pipeline_sync(pipeline_id)
        
        # Update execution status
        execution.status = 'success' if result.success else 'failed'
        execution.finished_at = timezone.now()
        execution.save()
        
        return {'execution_id': str(execution.id), 'status': execution.status}
        
    except Exception as exc:
        self.retry(exc=exc, countdown=60, max_retries=3)
```

## Security Considerations

### CSRF Protection

```python
# Ensure CSRF protection is enabled
MIDDLEWARE = [
    'django.middleware.csrf.CsrfViewMiddleware',
    # other middleware
]
```

### User Authentication

```python
from django.contrib.auth.decorators import login_required
from django.contrib.auth.mixins import LoginRequiredMixin

@login_required
def protected_view(request):
    """Protected view requiring authentication."""
    pass

class ProtectedView(LoginRequiredMixin, View):
    """Protected class-based view."""
    pass
```

### Permission System

```python
from django.contrib.auth.models import Permission
from django.contrib.contenttypes.models import ContentType

# Create custom permissions
content_type = ContentType.objects.get_for_model(Pipeline)
permission = Permission.objects.create(
    codename='can_execute_pipeline',
    name='Can execute pipeline',
    content_type=content_type,
)
```

## Performance Optimization

### Database Optimization

```python
# Use select_related and prefetch_related
pipelines = Pipeline.objects.select_related('created_by').prefetch_related('execution_set')

# Database indexing
class Meta:
    indexes = [
        models.Index(fields=['created_at']),
        models.Index(fields=['status', 'created_at']),
    ]
```

### Caching

```python
from django.core.cache import cache
from django.views.decorators.cache import cache_page

@cache_page(60 * 15)  # Cache for 15 minutes
def cached_view(request):
    """Cached view."""
    pass

# Manual caching
def get_pipeline_stats():
    """Get pipeline statistics with caching."""
    cache_key = 'pipeline_stats'
    stats = cache.get(cache_key)
    
    if stats is None:
        stats = {
            'total': Pipeline.objects.count(),
            'active': Pipeline.objects.filter(is_active=True).count(),
        }
        cache.set(cache_key, stats, timeout=300)
    
    return stats
```

## Deployment

### Production Settings

```python
# Secure settings for production
SECURE_SSL_REDIRECT = True
SECURE_HSTS_SECONDS = 31536000
SECURE_HSTS_INCLUDE_SUBDOMAINS = True
SECURE_HSTS_PRELOAD = True
SECURE_CONTENT_TYPE_NOSNIFF = True
SECURE_BROWSER_XSS_FILTER = True
X_FRAME_OPTIONS = 'DENY'
```

### Static Files

```python
# Static files configuration
STATIC_URL = '/static/'
STATIC_ROOT = BASE_DIR / 'staticfiles'
STATICFILES_STORAGE = 'whitenoise.storage.CompressedManifestStaticFilesStorage'
```

## Related Documentation

- [Django Documentation](https://docs.djangoproject.com/)
- [Django REST Framework](https://www.django-rest-framework.org/)
- [Clean Architecture in Django](../../docs/architecture/django-clean-arch.md)
- [Web Security Guide](../../docs/security/web-security.md)