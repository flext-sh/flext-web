{% extends "base.html" %} {% block title %}{{ pipeline.name }} - Pipelines -
FLEXT Enterprise{% endblock %} {% block content %}
<div class="container mx-auto px-4 py-8">
  <a
    href="{% url 'pipelines:list' %}"
    class="text-indigo-600 hover:text-indigo-900 mb-4 inline-block"
    >&larr; Back to Pipelines</a
  >
  <div class="bg-white shadow-md rounded-lg overflow-hidden">
    <div class="px-6 py-4 bg-gray-100 border-b-2 border-gray-200">
      <h1 class="text-2xl font-bold">{{ pipeline.name }}</h1>
    </div>
    <div class="p-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <h2 class="text-lg font-semibold text-gray-700 mb-2">Details</h2>
          <dl>
            <dt class="font-semibold text-gray-600">ID</dt>
            <dd class="text-gray-900 mb-2">{{ pipeline.id }}</dd>
            <dt class="font-semibold text-gray-600">State</dt>
            <dd class="text-gray-900 mb-2">{{ pipeline.state }}</dd>
            <dt class="font-semibold text-gray-600">Schedule</dt>
            <dd class="text-gray-900 mb-2">{{ pipeline.interval }}</dd>
          </dl>
        </div>
        <div>
          <h2 class="text-lg font-semibold text-gray-700 mb-2">Execution</h2>
          <dl>
            <dt class="font-semibold text-gray-600">Last Run</dt>
            <dd class="text-gray-900 mb-2">
              {{ pipeline.last_run_at|date:"Y-m-d H:i:s"|default:"Never" }}
            </dd>
            <dt class="font-semibold text-gray-600">Next Run</dt>
            <dd class="text-gray-900 mb-2">
              {{ pipeline.next_run_at|date:"Y-m-d H:i:s"|default:"Not scheduled"
              }}
            </dd>
          </dl>
        </div>
        <div class="md:col-span-2">
          <h2 class="text-lg font-semibold text-gray-700 mt-4 mb-2">
            Meltano Configuration
          </h2>
          <dl>
            <dt class="font-semibold text-gray-600">Plugin Namespace</dt>
            <dd class="text-gray-900 mb-2 font-mono">
              {{ pipeline.plugin_namespace }}
            </dd>
            <dt class="font-semibold text-gray-600">Extractor</dt>
            <dd class="text-gray-900 mb-2 font-mono">
              {{ pipeline.extractor }}
            </dd>
            <dt class="font-semibold text-gray-600">Loader</dt>
            <dd class="text-gray-900 mb-2 font-mono">{{ pipeline.loader }}</dd>
            <dt class="font-semibold text-gray-600">Transform</dt>
            <dd class="text-gray-900 mb-2 font-mono">
              {{ pipeline.transform }}
            </dd>
          </dl>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  let ws = null;
  const WS_URL = `ws://localhost:8000/api/ws/pipeline-{{ pipeline.id }}-{{ user.id }}`;

  function connectWebSocket() {
    ws = new WebSocket(WS_URL);

    ws.onopen = function () {
      // Subscribe to pipeline updates
      ws.send(
        JSON.stringify({
          type: "subscribe",
          event: `pipeline.{{ pipeline.id }}`,
        }),
      );
    };

    ws.onmessage = function (event) {
      const data = JSON.parse(event.data);

      if (data.type === "execution_update") {
        updateExecutionRow(data.execution);
      } else if (data.type === "pipeline_update") {
        location.reload();
      }
    };
  }

  function updateExecutionRow(execution) {
    const row = $(`#executionsTable tr[data-execution-id="${execution.id}"]`);
    if (row.length) {
      // Update existing row
      row.find(".status-badge").replaceWith(getStatusBadge(execution.status));
      row.find(".duration").text(execution.duration || "-");
    } else {
      // Add new row at top
      refreshExecutions();
    }
  }

  function getStatusBadge(status) {
    const badges = {
      completed: '<span class="badge bg-success">Completed</span>',
      running:
        '<span class="badge bg-primary"><span class="spinner-border spinner-border-sm me-1"></span>Running</span>',
      failed: '<span class="badge bg-danger">Failed</span>',
      cancelled: '<span class="badge bg-warning">Cancelled</span>',
    };
    return (
      badges[status] || `<span class="badge bg-secondary">${status}</span>`
    );
  }

  function runPipeline(pipelineId) {
    $.post(`/api/pipelines/${pipelineId}/run/`, {
      csrfmiddlewaretoken: getCookie("csrftoken"),
    })
      .done(function (data) {
        window.location.href = `/pipelines/execution/${data.execution_id}/`;
      })
      .fail(function (xhr) {
        alert("Error running pipeline: " + xhr.responseJSON.error);
      });
  }

  function togglePipeline(pipelineId, isActive) {
    const action = isActive ? "deactivate" : "activate";

    $.post(`/api/pipelines/${pipelineId}/${action}/`, {
      csrfmiddlewaretoken: getCookie("csrftoken"),
    })
      .done(function () {
        location.reload();
      })
      .fail(function (xhr) {
        alert(`Error ${action}ing pipeline: ` + xhr.responseJSON.error);
      });
  }

  function cancelExecution(executionId) {
    if (confirm("Are you sure you want to cancel this execution?")) {
      $.post(`/api/executions/${executionId}/cancel/`, {
        csrfmiddlewaretoken: getCookie("csrftoken"),
      })
        .done(function () {
          refreshExecutions();
        })
        .fail(function (xhr) {
          alert("Error cancelling execution: " + xhr.responseJSON.error);
        });
    }
  }

  function exportPipeline(pipelineId) {
    window.location.href = `/api/pipelines/${pipelineId}/export/`;
  }

  function deletePipeline(pipelineId, pipelineName) {
    if (
      confirm(
        `Are you sure you want to delete pipeline "${pipelineName}"? This action cannot be undone.`,
      )
    ) {
      $.ajax({
        url: `/api/pipelines/${pipelineId}/`,
        type: "DELETE",
        headers: {
          "X-CSRFToken": getCookie("csrftoken"),
        },
      })
        .done(function () {
          window.location.href = '{% url "pipelines:list" %}';
        })
        .fail(function (xhr) {
          alert("Error deleting pipeline: " + xhr.responseJSON.error);
        });
    }
  }

  function refreshExecutions() {
    $.get(`/api/pipelines/{{ pipeline.id }}/executions/`).done(function (data) {
      // Update executions table
      const tbody = $("#executionsTable tbody");
      tbody.empty();

      if (data.executions.length === 0) {
        tbody.append(
          '<tr><td colspan="5" class="text-center text-muted">No executions yet</td></tr>',
        );
        return;
      }

      data.executions.forEach(function (execution) {
        const row = `
                <tr data-execution-id="${execution.id}">
                    <td><a href="/pipelines/execution/${execution.id}/">${execution.id.substring(0, 12)}</a></td>
                    <td class="status-badge">${getStatusBadge(execution.status)}</td>
                    <td>${new Date(execution.started_at).toLocaleString()}</td>
                    <td class="duration">${execution.duration || "-"}</td>
                    <td>
                        <div class="btn-group" role="group">
                            <a href="/pipelines/execution/${execution.id}/" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-eye"></i>
                            </a>
                            ${
                              execution.status === "running"
                                ? `<button class="btn btn-sm btn-outline-danger" onclick="cancelExecution('${execution.id}')">
                                    <i class="fas fa-stop"></i>
                                </button>`
                                : ""
                            }
                        </div>
                    </td>
                </tr>
            `;
        tbody.append(row);
      });
    });
  }

  // Initialize
  $(document).ready(function () {
    connectWebSocket();

    // Auto-refresh executions every 30 seconds
    setInterval(refreshExecutions, 30000);
  });

  // Cleanup
  window.addEventListener("beforeunload", function () {
    if (ws) {
      ws.close();
    }
  });
</script>
{% endblock %}
